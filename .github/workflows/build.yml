name: LineageOS 23 - Manual Interactive Build
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: SlimHub Cleanup
        uses: rokibhasansagar/slimhub_actions@main

      - name: Maximize Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: Setup Tools & Sync
        run: |
          sudo apt update && sudo apt install -y bc bison build-essential curl flex g++-multilib \
          gcc-multilib git gnupg gperf libxml2-utils lz4 ncurses-dev python3 \
          libssl-dev rsync unzip zip zlib1g-dev python-is-python3
          mkdir -p ~/bin && curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=~/bin:$PATH
          
          mkdir android && cd android
          repo init -u https://github.com/LineageOS/android.git -b lineage-23.0 --depth=1
          
          # Clones (do these here so they are ready when you SSH in)
          git clone --depth=1 https://github.com/a325g/device_samsung_a32x.git device/samsung/a32x
          git clone --depth=1 https://github.com/Yenping0001/vendor_samsung_a32x.git vendor_samsung_a32x
          git clone --depth=1 https://github.com/Yenping0001/android_kernel_samsung_a32x.git kernel/samsung/a32x
          
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
          rm -rf .repo

      - name: Setup Interactive SSH Session
        uses: mxschmitt/action-tmate@v3
        with:
          # This stops the "Permission Denied / Connection Reset" 
          # by allowing you to enter via the Web URL without an SSH key.
          limit-access-to-actor: false
          
          # This prevents the session from closing if the 
          # connection is briefly unstable.
          connect-timeout-seconds: 60


      # This step stays here as a placeholder for when you "detach" or finish
      - name: Final Upload
        uses: softprops/action-gh-release@v2
        if: always()
        with:
          files: android/out/target/product/a32x/lineage-*.zip
          tag_name: manual-build-${{ github.run_id }}
          
