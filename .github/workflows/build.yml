name: DerpFest AOSP - Samsung A32 (Final Attempt)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Aggressive Manual Cleanup
        run: |
          sudo rm -rf /usr/local/share/boost /usr/local/lib/android /opt/ghc /usr/share/dotnet /opt/az /usr/share/swift
          sudo apt-get clean

      - name: Install Build Tools
        run: |
          sudo apt update && sudo apt install -y bc bison build-essential ccache curl flex g++-multilib \
          gcc-multilib git gnupg gperf libxml2-utils lz4 ncurses-dev python3 \
          libssl-dev rsync unzip zip zlib1g-dev python-is-python3
          mkdir -p ~/bin && curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo

      - name: Modular Sync & Purge
        run: |
          export PATH=~/bin:$PATH
          mkdir android && cd android
          
          # 1. Initialize with Extreme Filtering
          repo init -u https://github.com/DerpFest-AOSP/manifest.git -b 14 --depth=1 --partial-clone --clone-filter=blob:none
          
          # 2. Add Samsung A32 Trees (Shallow)
          git clone --depth=1 https://github.com/a325g/device_samsung_a32x.git device/samsung/a32x
          git clone --depth=1 https://github.com/Yenping0001/vendor_samsung_a32x.git vendor/samsung/a32x
          git clone --depth=1 https://github.com/Yenping0001/android_kernel_samsung_a32x.git kernel/samsung/a32x
          
          # 3. Step-by-Step Sync to avoid disk overflow
          # Sync only the most essential build logic first
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags build/make build/soong
          
          # Sync everything else
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
          
          echo "DISK USAGE BEFORE PURGE:"
          df -h /
          
          # 4. NUCLEAR PURGE: Deleting .repo to make room for 'out/' folder
          # This is the ONLY way to survive a DerpFest build on 70GB
          rm -rf .repo

      - name: Build ROM
        run: |
          export PATH=~/bin:$PATH
          cd android
          
          # We disable CCACHE because we have 0 bytes for a cache folder
          # The compiler needs all free space for the 'out/' directory
          export USE_CCACHE=0
          
          source build/envsetup.sh
          
          # Verify your lunch target. Check device/samsung/a32x/AndroidProducts.mk
          lunch derpfest_a32x-userdebug
          
          # Build - we use 'm' instead of 'mka' to be more conservative with RAM/Swap
          m derp -j$(nproc --all)

      - name: Upload to Releases
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          files: android/out/target/product/a32x/DerpFest*.zip
          tag_name: a325g-${{ github.run_id }}
          name: DerpFest Build for A32
          body: "ROM Build Complete"
          
